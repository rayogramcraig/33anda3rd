<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Label Capture POC</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    video, canvas { max-width: 100%; border: 1px solid #ccc; }
    #overlay {
      position: absolute;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.8);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Record Label Capture (POC)</h1>

  <div style="position:relative; display:inline-block;">
    <video id="video" autoplay playsinline></video>
    <!-- simple circular overlay to aim the label -->
    <div id="overlay"></div>
  </div>

  <br />
  <button id="captureBtn">Capture Label</button>

  <h2>Captured Frame</h2>
  <canvas id="canvas"></canvas>

  <h2>OCR Result</h2>
  <pre id="ocrText"></pre>
  <p id="discogsLink"></p>

  <!-- Tesseract.js from a CDN -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const ocrText = document.getElementById('ocrText');
    const discogsLink = document.getElementById('discogsLink');
    const overlay = document.getElementById('overlay');

    // Start camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          // size overlay to be roughly label-sized
          const size = Math.min(video.videoWidth, video.videoHeight) * 0.6;
          overlay.style.width = size + 'px';
          overlay.style.height = size + 'px';
          overlay.style.left = (video.offsetWidth - size) / 2 + 'px';
          overlay.style.top = (video.offsetHeight - size) / 2 + 'px';
        });
      })
      .catch(err => console.error('Camera error:', err));

    captureBtn.addEventListener('click', async () => {
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      // run OCR on full frame (POC – later you’d crop to overlay region)
      const dataUrl = canvas.toDataURL('image/png');

      ocrText.textContent = 'Reading…';
      discogsLink.textContent = '';

      const { data } = await Tesseract.recognize(dataUrl, 'eng', {
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 .-/'
      });
      const text = data.text;
      ocrText.textContent = text;

      // super naive catalog guess: longest token with digits
      const tokens = text.split(/\s+/);
      let best = '';
      for (const t of tokens) {
        if (/\d/.test(t) && t.length > best.length) best = t.replace(/[^A-Za-z0-9\-]/g, '');
      }
      if (best) {
        const query = encodeURIComponent(text);
        const url = `https://www.discogs.com/search/?q=${query}&type=all`;
        discogsLink.innerHTML = `Discogs search: <a href="${url}" target="_blank">${best}</a>`;
      }
    });
  </script>
</body>
</html>
